<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        메플리케이션
    </title>
    <!-- jQuery cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- jQuery ui cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"
        integrity="sha512-57oZ/vW8ANMjR/KQ6Be9v/+/h6bq9/l3f0Oc7vn6qMqyhvPd1cvKBRWWpzu0QoneImqr2SkmO4MSqU+RpHom3Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- jQurey ui css cdn -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css"
        integrity="sha512-ELV+xyi8IhEApPS/pSj66+Jiw+sOT1Mqkzlh8ExXihe4zfqbWkxPRi8wptXIO9g73FSlhmquFlUOuMSoXz5IRw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/js/bootstrap.min.js"
        integrity="sha512-8Y8eGK92dzouwpROIppwr+0kPauu0qqtnzZZNEF8Pat5tuRNJxJXCkbQfJ0HlUG3y1HB3z18CSKmUo7i2zcPpg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- CSS only -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css"
        integrity="sha512-XWTTruHZEYJsxV3W/lSXG1n3Q39YIWOstqvmFsdNEEQfHoZ6vm6E9GK2OrF6DSJSpIbRbi+Nn0WDPID9O7xB2Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- css -->
    <link rel="stylesheet" type="text/css" href="/css/common.css">
</head>
<style>
    /* .title {
            font-size: 20px;
        }

        @media (min-width: 640px) {
            .title {
                font-size: 14px;
                color: red;
            }
        }
        
        @media (min-width: 768px) {
            .title {
                font-size: 16px;
                color: orange;
            }
        } */
    .table {
        text-align: center;
        vertical-align: middle;
    }
    .name_zone {
        width: 60%;
    }
    .date_zone {
        width: 15%;
    }
    .time_zone {
        width: 15%;
    }
    .delete_zone {
        width: 10%;
    }
    .a {
        margin: 4px;
        height: 31px;
    }
</style>

<body>
    <header></header>
    <main>
        <div class="container">
            <div style="margin: 10px; text-align: center;">
                <label>아이템이름</label><input type="text" id="name" class="a">
                <label>만료날짜</label><input type="text" id="datepicker" class="a">
                <label>만료시각</label><input type="text" maxlength="4" id="time" class="a">
                <button id="btn_regist" class="btn btn-primary btn-sm" style="position: relative; top: -2px;">등록</button>
            </div>
            <hr>
            <table class="table">
                <colgroup>
                    <col class="name_zone">
                    <col class="date_zone">
                    <col class="time_zone">
                    <col class="delete_zone">
                </colgroup>
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>만료날짜</th>
                        <th>남은시간</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-rds="1234">
                        <td>영원한 환생의 불꽃</td>
                        <td>2022.08.26.<br>13시 13분</td>
                        <td data-date="202208261313" class="remaining_time"></td>
                        <td><button class="btn_delete btn btn-danger">삭제</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    <footer></footer>
    <script>
        $(function () {
            // datepicker초기화
            $("#datepicker").datepicker({
                changeMonth: true,
                dateFormat: 'yy.mm.dd.',
                monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                monthNamesShort: ['1,', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                dayNames: ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'],
                dayNamesMin: ['월', '화', '수', '목', '금', '토', '일'],
                onSelect: function (dateText, inst) {
                    $('#time').focus();
                }
            });

            // autocomplete
            $("#name").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        type: "get",
                        url: "itemList.json",
                        dataType: "json",
                        success: function (data) {
                            response(
                                $.map(data, function (item) {
                                    if (item.indexOf(request.term) >= 0) {
                                        return {
                                            label: item,
                                            value: item
                                        };
                                    }
                                })
                            );
                        }
                    });
                },
                minLength: 1,
                focus: function (event, ui) {
                    return false;
                },
                select: function (event, ui) {
                    $('#datepicker').focus();
                }
            });

            // 로컬스토리지 확인
            if(localStorage.getItem("list") == null) localStorage.setItem("list", "[]");
            

            // 로컬스토리지 리스트 확인
            for (i of JSON.parse(localStorage.getItem("list"))) {
                let content = `
                    <tr data-rds="${i['rds']}">
                        <td>${i['name']}</td>
                        <td>${i['date']}<br>${i['time']}</td>
                        <td data-date="${i['eDate']}" class="remaining_time"></td>
                        <td>
                            <button class="btn_delete btn btn-danger">삭제</button>
                        </td>
                    </tr>`
                $('.table tbody').append(content)
            };
        });

        // 남은시간 업데이트
        function remainingUpdate() {
            let $arr = $('.table tbody').children();
            let now = new Date();
            let nDate = new Date(now.getFullYear(), now.getMonth()+1, now.getDate(), now.getHours(), now.getMinutes());

            for(let i=0; i<$arr.length; i++) {
                let expire = subdate(String($arr.eq(i).children().eq(2).data('date')));
                let eDate = new Date(expire.year, expire.mouth, expire.day, expire.hour, expire.min);

                diffMSec = eDate.getTime() - nDate.getTime();
                rMin = diffMSec / 1000 / 60 % 60;
                rHour = parseInt(diffMSec / 1000 / 60 / 60 % 24);
                rDay = parseInt(diffMSec / 1000 / 60 / 60 / 24);

                if(rDay < 0 || rHour < 0 || rMin < 0) $arr.eq(i).css('border-left', 'solid Gray 10px');
                else if(rDay > 7) $arr.eq(i).css('border-left', 'solid Green 10px');
                else if(rDay > 4) $arr.eq(i).css('border-left', 'solid Orange 10px');
                else if(rDay >= 0) $arr.eq(i).css('border-left', 'solid Red 10px');
                

                $arr.eq(i).children().eq(2).html(rDay + '일 ' + rHour + '시간 ' + rMin + '분');
            }
        }
        setInterval(remainingUpdate, 1000);

        // 시간 자동 변경
        $("#time").change(function() {
            let date = $("#time").val();
            let h = date.substr(0, 2),
                m = date.substr(2, 2);

            if(parseInt(h) > 24 || parseInt(m) >= 60) {
                alert('시간을 잘못 입력했습니다.')
                $('#time').val('');
            }
            
            $("#time").val(h + '시 ' + m + '분');
        });

        // 시간칸 클릭시 초기화
        $("#time").click(function () {
            $("#time").val("");
        });

        // 등록버튼
        $('#btn_regist').click(function () {
            let $name = $('#name'),
                $date = $('#datepicker'),
                $time = $('#time'),
                rds = randomStr();
            let eDate = $date.val().replace(/[^0-9]/g, '') + $time.val().replace(/[^0-9]/g, '');

            // 빈칸 확인
            if ($name.val() == '') {
                alert("아이템 이름을 입력해주세요.");
                $('#name').focus()
                return;
            };
            if ($date.val() == '') {
                alert("날짜를 입력해주세요.");
                $('#datepicker').focus()
                return;
            };
            if ($time.val() == '') {
                alert("시간을 입력해주세요.");
                $('#time').focus()
                return;
            };

            let content  = `
                <tr data-rds="${rds}">
                    <td>${$name.val()}</td>
                    <td>${$date.val()}<br>${$time.val()}</td>
                    <td data-date="${eDate}" class="remaining_time"></td>
                    <td>
                        <button class="btn_delete btn btn-danger">삭제</button>
                    </td>
                </tr>`

            $('.table tbody').append(content)

            // 로컬스토리지
            let obj = {
                rds: rds,
                name: $name.val(),
                date: $date.val(),
                time: $time.val(),
                eDate: eDate},
                list = JSON.parse(localStorage.getItem("list"));
            list.push(obj);
            localStorage.setItem("list", JSON.stringify(list));

            // 초기화
            $name.val('');
            $date.val('');
            $time.val('');
        });

        // 삭제버튼
        $(document).on('click', '.btn_delete', function() {
            let rds = $(this).parents().eq(1).data('rds');
            let filterArr = JSON.parse(localStorage.getItem('list')).filter(function(data) {
                return data['rds'] != rds;
            });

            $(this).parents('tr').remove();
            localStorage.setItem('list', JSON.stringify(filterArr));
        })

        // 시간날짜분리
        function subdate(date) {
            return {
                year: date.substr(0, 4),
                mouth: date.substr(4, 2),
                day: date.substr(6, 2),
                hour: date.substr(8, 2),
                min: date.substr(10, 2)};
        }

        // 랜덤 문자열
        function randomStr() {
            let rds = Math.random().toString(36).substring(2, 12),
                list = localStorage.getItem("list");

            if (list.indexOf(rds) > 0) rds = randomStr();

            return rds;
        }

        // includeHTML
        $('header').load('/include/header.html');
        $('footer').load('/include/footer.html');
    </script>
</body>

</html>